<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>File Upload Example</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


</head>
<body>
<div class="container">
    <script>
        $(document).ready(function() {

            // Constraint
            var maxFiles = 3;
            var currentFiles = 1;
            var fileTable = $('#fileTable');

            /**
             * Add a new file row
             */
            $('#addFile').click(function() {

                if(currentFiles < 3){

                    currentFiles++;

                    var fileIndex = $('#fileTable tr').children().length;
                    $('#fileTable tbody tr:last-child').clone().appendTo($('#fileTable tbody'));
                    $('#fileTable tbody tr:last-child td div input').attr('name', 'files[' + fileIndex + ']');
                    $('#fileTable tbody tr:last-child td div input').val('');
                    $('#fileTable tbody tr:last-child').hide().fadeIn(400);
                }
                else alert('Limite de 3 fichiers atteinte !');

            });

            /**
             * Delete a file row
             */
            fileTable.on('click', '.btn.btn-danger', function (e) {

                $(this).closest('div').find('input').val('');

                var rowCount = $('#fileTable tr').length;

                if(rowCount > 1){
                    $(this).parent().parent().parent().find('.file').val('');
                    var tRow = $(this).closest('tr');
                    //tRow.remove();
                    tRow.fadeOut(400, function () { this.remove(); });
                    currentFiles--;
                }
            });

            $('#btnUpload').click(function (e) {

                e.preventDefault();

                $(this).prop('disabled', true);

                $('#progressDiv').removeAttr('hidden');

                var form = document.forms[0];
                var formData = new FormData(form);

                var ajaxRequest = $.ajax({
                    url: '/save',
                    type: 'POST',
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false,
                    xhr: function () {
                        var xhr = $.ajaxSettings.xhr();

                        xhr.upload.onprogress = function (ev) {
                            var perc = Math.round((ev.loaded / ev.total) * 100);
                            $('#progressBar').text(perc + ' %');
                            $('#progressBar').css('width', perc + '%');
                        };
                        return xhr;
                    },
                    beforeSend: function (xhr) {
                        $('#alertMsg').text('');
                        $('#progressBar').text('');
                        $('#progressBar').css('width', '0%');
                    }
                });

                // Called on success of file upload
                ajaxRequest.done(function(msg) {
                    $('#alertMsg').text(msg);
                    $('input[type=file]').val('');
                    $('button[type=submit]').prop('disabled',false);
                });
                // Called on failure of file upload
                ajaxRequest.fail(function(jqXHR) {
                    $('#alertMsg').text(jqXHR.responseText+'('+jqXHR.status+
                        ' - '+jqXHR.statusText+')');
                    $('button[type=submit]').prop('disabled',false);
                });
            })
        });
        $(document).on('click', '.browse', function(){
            var file = $(this).parent().parent().parent().find('.file');
            file.trigger('click');
        });
        $(document).on('change', '.file', function(){
            $(this).parent().find('.form-control').val($(this).val().replace(/C:\\fakepath\\/i, ''));
        });
    </script>
    <style>
        .file {
            visibility: hidden;
            position: absolute;
        }
        table.borderless td,table.borderless th{
            border: none !important;
        }
        .table > tbody > tr {
            vertical-align: middle;
        }
        .alert {
            height: 10px;
            line-height: 0px;
        }
    </style>
    <h3>Déposer des fichiers</h3>
    <form class="form" method="post" th:action="@{/save}" th:object="${uploadForm}" enctype="multipart/form-data">
        <p>Sélectionnez plusieurs fichiers à transférer en cliquant sur le bouton 'ajouter un fichier' (max 3).</p>
        <ul>
            <li>Limite de 3 fichiers par transfert</li>
            <li>Limite de 10 Mo maximum par fichier</li>
        </ul>
        <hr>
        <button id="addFile" type="button" class="btn btn-warning">Ajouter un fichier</button>
        <br>
        <br>
        <table class="table borderless table-condensed" id="fileTable">
            <tbody>
                <tr>
                    <td>
                        <div class="form-group">
                            <input type="file" name="files[0]" class="file" accept="application/pdf, image/*">
                            <div class="input-group col-xs-12">
                                <span class="input-group-addon">
                                    <i class="glyphicon glyphicon-file"></i>
                                </span>
                                <input type="text" class="form-control input"
                                       readonly value=""
                                       placeholder="Sélectionner un fichier en cliquant sur le bouton 'parcourir' ci-contre">
                                <span class="input-group-btn">
                                    <button class="btn btn-danger" type="button">
                                        <i class="glyphicon glyphicon-remove"></i>
                                    </button>
                                    <button class="browse btn btn-primary input" type="button">
                                        <i class="glyphicon glyphicon-search"></i>
                                        Parcourir
                                    </button>
                                </span>
                            </div>
                            <p class="alert alert-success">Taille du fichier</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        <hr>
        <button class="btn btn-success" id="btnUpload" type="submit">Transférer</button>
    </form>
    <br>
    <!-- Bootstrap Progress bar -->
    <div class="progress" hidden id="progressDiv">
        <div id="progressBar" class="progress-bar progress-bar-success" role="progressbar"
             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">0%</div>
    </div>

    <!-- Alert -->
    <div id="alertMsg" style="color: red;font-size: 18px;"></div>
</div>

</body>

</html>